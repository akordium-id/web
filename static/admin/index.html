<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Akordium Content Manager</title>
  </head>

  <body>
    <!-- Tambahkan elemen root untuk Decap CMS -->
    <div id="nc-root"></div>

    <!-- Handle auth callback first, before loading CMS script -->
    <script>
      // Bersihkan localStorage untuk menghindari error QUOTA_BYTES_PER_ITEM
      try {
        // Simpan hanya data penting dan hapus yang lain
        const userData = localStorage.getItem("netlify-cms-user");
        localStorage.clear();
        if (userData) {
          localStorage.setItem("netlify-cms-user", userData);
        }
      } catch (e) {
        console.log("Error clearing localStorage:", e);
      }

      // Handle auth callback
      if (window.location.hash.includes("auth-callback")) {
        // Extract code from hash
        const code = window.location.hash.split("=")[1];

        if (code) {
          // Send to backend for exchange
          fetch("/api/auth", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ code }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.access_token) {
                // Simpan token dengan format yang lebih sederhana
                const minimalUserData = {
                  token: { access_token: data.access_token },
                };
                localStorage.setItem(
                  "netlify-cms-user",
                  JSON.stringify(minimalUserData),
                );
                console.log("Authentication successful");
              }
              // Bersihkan hash dan reload
              window.location.href = "/admin/";
            })
            .catch((error) => {
              console.error("Auth error:", error);
            });
        }
      }
    </script>

    <!-- Include the Decap CMS script after auth handling -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

    <!-- Initialize CMS with configuration -->
    <script>
      // Only initialize if not in auth callback flow
      if (!window.location.hash.includes("auth-callback")) {
        // Configure Decap CMS
        window.CMS_MANUAL_INIT = true;

        const config = {
          backend: {
            name: "github",
            repo: "akordium-id/your-repo", // Ganti dengan repo Anda
            base_url: "https://akordium.id",
            auth_endpoint: "/api/auth", // Tambahkan slash di depan
            auth_type: "implicit", // Pastikan menggunakan implicit flow
            app_id: "Ov23liJSf1T2kc8slkHe", // Tambahkan client ID GitHub Anda
          },
          load_config_file: false,
          media_folder: "static/images",
          public_folder: "/images",
          collections: [
            {
              name: "blog",
              label: "Blog",
              folder: "content/blog",
              create: true,
              slug: "{{year}}-{{month}}-{{day}}-{{slug}}",
              fields: [
                { label: "Title", name: "title", widget: "string" },
                {
                  label: "Publish Date",
                  name: "date",
                  widget: "datetime",
                },
                {
                  label: "Featured Image",
                  name: "thumbnail",
                  widget: "image",
                  required: false,
                },
                { label: "Body", name: "body", widget: "markdown" },
              ],
            },
          ],
        };

        // Tunggu sampai DOM dan CMS benar-benar dimuat
        window.addEventListener("load", function () {
          setTimeout(function () {
            try {
              if (window.CMS) {
                window.CMS.init({ config });
              } else {
                console.error("CMS not loaded properly");
              }
            } catch (e) {
              console.error("Error initializing CMS:", e);
            }
          }, 100); // Tambahkan sedikit delay untuk memastikan DOM siap
        });
      }
    </script>
  </body>
</html>
